# Makefile.in -- Makefile for libmaa
# Created: Sun Nov 19 13:32:41 1995 by faith@dict.org
# Copyright 1995-1998, 2002 Rickard E. Faith (faith@dict.org)
# Copyright 2002-2010 Aleksey Cheusov (vle@gmx.net)
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

MAA_MAJOR=@MAA_MAJOR@
MAA_MINOR=@MAA_MINOR@
MAA_TEENY=@MAA_TEENY@

VERSION=$(MAA_MAJOR).$(MAA_MINOR).$(MAA_TEENY)

.SUFFIXES:
.SUFFIXES: .c .o

srcdir=		@srcdir@
VPATH=		@srcdir@
prefix=		@prefix@
exec_prefix=	@exec_prefix@
libdir=         @libdir@
includedir=     @includedir@
subdirs=        doc

CC=		@CC@
CPP=		@CPP@
LIBTOOL=	@LIBTOOL@
INSTALL=        @INSTALL@
INSTALL_PROGRAM=@INSTALL_PROGRAM@
INSTALL_DATA=	@INSTALL_DATA@
AWK=            @AWK@

VERCFLAGS=       -DMAA_MAJOR=$(MAA_MAJOR) -DMAA_MINOR=$(MAA_MINOR) -DMAA_TEENY=$(MAA_TEENY)
CFLAGS=		@DEFS@ @CPPFLAGS@ @CFLAGS@ $(VERCFLAGS) -I. -I${srcdir}
LDFLAGS=        @LDFLAGS@
LIBS=	        @LIBS@ -lm

TESTLIBS=	-L.libs -lmaa

HEADERS= config.h maa.h maaP.h obstack.h
LIBOBJS= @LIBOBJS@ obstack.o xmalloc.o \
	 hash.o set.o stack.o list.o error.o memory.o string.o \
	 debug.o flags.o maa.o prime.o bit.o timer.o \
	 arg.o pr.o sl.o base64.o base26.o source.o parse-concrete.o \
	 text.o log.o
TESTS=	 settest hashtest stringtest debugtest \
	 primetest listtest bittest argtest sltest prtest basetest
TESTS_SH= logtest.sh
EXES=    memtest prtest

MAALIB=  libmaa.la

lib: $(MAALIB)

all: $(MAALIB) $(EXES) $(TESTS) logtest
	echo making $@ in doc; \
	(cd doc && $(MAKE) $@) || exit 1;

install: $(MAALIB)
	mkdir -p $(DESTDIR)$(libdir) && \
	   $(LIBTOOL) --mode=install $(INSTALL) -c libmaa.la $(DESTDIR)$(libdir)
	mkdir -p $(DESTDIR)$(includedir) && \
	   $(INSTALL_DATA) -c -m 644 ${srcdir}/maa.h $(DESTDIR)$(includedir)

uninstall:
	rm -f $(DESTDIR)$(includedir)/maa.h
	$(LIBTOOL) --mode=uninstall rm -f $(DESTDIR)$(libdir)/libmaa.la

.PHONY: test
test: $(TESTS) logtest
	@ex=0; \
	if test "${srcdir}" != .; then \
		cp ${srcdir}/argtest.in ${srcdir}/logtest.sh .; \
	fi; \
	for i in $(TESTS) $(TESTS_SH); do \
		./$$i | fgrep -v ' at ' > ./$$i.out.new; \
		if cmp @srcdir@/$$i.out $$i.out.new; \
		then \
			echo PASSED $$i; rm -f $$i.out.new; \
		else \
			echo FAILED $$i; ex=1; \
		fi; \
	done; \
	exit $$ex

.PHONY: test-update
test-update: $(TESTS)
	@for i in $(TESTS) $(TESTS_SH); do \
		echo Writing $$i.out; \
		./$$i | fgrep -v ' at ' > $$i.out; \
	done

arg.o: arggram.c
arggram.c: ${srcdir}/arggram.txt
	@AWK@ -f ./arggram2c < ${srcdir}/arggram.txt > $@

.c.o:
	$(LIBTOOL) --tag=CC --mode=compile $(CC) -o $@ -c $(CFLAGS) $<

settest    : settest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
hashtest   : hashtest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
stringtest : stringtest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
debugtest  : debugtest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
primetest  : primetest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
listtest   : listtest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
bittest    : bittest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
argtest    : argtest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
sltest     : sltest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
prtest     : prtest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
basetest   : basetest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)
logtest   : logtest.o rnd.o $(MAALIB)
	$(LIBTOOL) --tag=CC --mode=link $(CC) -o $@ $@.o rnd.o $(LDFLAGS) $(TESTLIBS) $(LIBS)

$(MAALIB): $(LIBOBJS)
	$(LIBTOOL) --tag=CC --mode=link ${CC} -o libmaa.la ${LIBOBJS:.o=.lo} \
	   $(LDFLAGS) $(LIBS) \
	   -rpath "${libdir}" -export-symbols ${srcdir}/export.sym \
	   -version-info 3:0

$(LIBOBJS): $(HEADERS) # version.stamp # don't automatically bump version
$(EXES):    $(HEADERS) $(MAALIB)
$(TESTS):   $(HEADERS) $(MAALIB) rnd.o

.PHONY: ChangeLog
ChangeLog:
	(echo "***** Making new ChangeLog..."; \
	rm -f ChangeLog; \
	AWK=@AWK@ rcs2log -i 2 | \
	sed -e 's,/cvsroot/dict/dictd1/,,g' \
	      -e 's,/cvs/dict/dictd1/,,g' \
	      -e 's,@[^>]*,@,g' \
	      -e 's,cheusov@[^>]*,vle@gmx.net,g' \
	      -e 's,faith@[^>]*,faith@dict.org,g' \
	      -e 's,hilliard...hilliard@.*,Bob Hilliard  <hilliard@debian.org>,g' \
	      -e 's,tek...tek@.*,Julian Squires  <tek@wiw.org>,g' \
              -e 's,\(.*\)<\([^@<>]\+\)@\([^@<>]\+\)>\(.*\),\1<\2 at \3}\4,g' \
	> ChangeLog)

.PHONY: cvsdist
cvsdist:
	@( CVSROOT=`cat CVS/Root` && \
	export CVSROOT && \
	VERSION=$(VERSION) && \
	VERSION_CVS=`echo $${VERSION} | tr . -` && \
	export VERSION VERSION_CVS && \
	$(MAKE) ChangeLog && \
	cp ChangeLog /tmp/libmaa.ChangeLog.$${VERSION} && \
	echo "***** Exporting files for libmaa-$${VERSION}..." && \
	cd /tmp && \
	rm -rf /tmp/libmaa-$${VERSION} && \
	cvs export -fd libmaa-$${VERSION} \
	   -r libmaa-$${VERSION_CVS} dictd1/libmaa && \
	cd libmaa-$${VERSION} && \
	mv /tmp/libmaa.ChangeLog.$${VERSION} ChangeLog && \
	autoheader && autoconf && \
	rm -rf autom4te.cache libmaa/autom4te.cache && \
	chmod -R a+rX,g-w . && \
	cd .. && \
	echo "***** Taring and zipping libmaa-$${VERSION}.tar.gz..." && \
	tar cvvf libmaa-$${VERSION}.tar libmaa-$${VERSION} && \
	gzip -9f libmaa-$${VERSION}.tar && \
	echo "***** Done making /tmp/libmaa-$${VERSION}.tar.gz")

.PHONY: clean cleandist tags
clean:
	@for subdir in `echo $(subdirs)`; do \
		echo making $@ in $$subdir; \
		(cd $$subdir && $(MAKE) $@) || exit 1; \
	done
	-rm -rf .libs
	-rm -f *~ *.la *.lo *.o core a.out config.log $(TESTS) $(EXES)
	-rm -f $(MAALIB) arggram.c
	-rm -f *.log *.aux *.toc *.dvi *.ps *.out.new
	-rm -f *.cfg *.dtk .inslog tca.map .pure
	-rm -f mkrnd

distclean: clean
	@for subdir in `echo $(subdirs)`; do \
		echo making $@ in $$subdir; \
		(cd $$subdir && $(MAKE) $@) || exit 1; \
	done
	-rm -f config.h config.h.in
	-rm -f config.cache config.status stamp-h.in stamp-h
	-rm -f Makefile arggram2c
	-rm -rf autom4te.cache

cvsclean: distclean
	rm -rf configure config.h.in

tags:
	etags: *.c

# The following is based on the "Automatic Remaking" node in the GNU
# Autoconf documentation:

$(srcdir)/configure: configure.in
	cd $(srcdir) && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in
	cd ${srcdir} && autoheader
	touch ${srcdir}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck
